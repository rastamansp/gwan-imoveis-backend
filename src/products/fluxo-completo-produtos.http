### ============================================
### FLUXO COMPLETO: VALIDAÇÃO DE INGRESSO → COMPRA DE PRODUTOS
### ============================================
### Este arquivo demonstra o fluxo completo desde a validação do ingresso
### via QR code até a compra e validação de produtos no evento.
### ============================================
###
### INSTRUÇÕES PARA PREENCHER AS VARIÁVEIS:
### 1. Faça login primeiro para obter o token:
###    POST /auth/login
###    Body: {"email":"pedro.hp.almeida@gmail.com","password":"PWD@7a7y5f"}
###    Copie o access_token da resposta para @token e @organizerToken
###
### 2. Para obter ticketId e qrCodeData:
###    GET /tickets/my-tickets (com token) - RECOMENDADO
###    Ou GET /tickets/my-tickets/{eventId} para ingressos de um evento específico
###    Copie o "id" para @ticketId e "qrCodeData" para @qrCodeData
###    Alternativa: GET /tickets (com token) ou criar um novo: POST /tickets
###
### 3. Para criar produtos e obter productIds:
###    POST /products (com organizerToken)
###    Copie os IDs retornados
###
### 4. Para obter orderId e productQrCode:
###    POST /orders (com token) - cria pedido
###    Copie orderId e qrCodeData dos items retornados
###
### 5. Para criar scanner (ADMIN):
###    POST /scanners (com token de admin)
###    Copie o "id" para @scannerId e "apiKey" para @scannerApiKey
### ============================================

### Variáveis Globais
@baseUrl = http://localhost:3001/api
@token = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InBlZHJvLmhwLmFsbWVpZGFAZ21haWwuY29tIiwic3ViIjoiNjZjNzY1NTItYzM5Yy00ZTkzLTg0ZTQtNGY2NzczMGU2ZWE3Iiwicm9sZSI6IkFETUlOIiwiaWF0IjoxNzYyNTMyMzEzLCJleHAiOjE3NjI2MTg3MTN9.hz7V7oN_Tm0EYLXrr2wVMCZ0RMDLFy48X2ROUuvWWKk
### Para obter o token: Execute a requisição de login abaixo e copie o access_token
@organizerToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InBlZHJvLmhwLmFsbWVpZGFAZ21haWwuY29tIiwic3ViIjoiNjZjNzY1NTItYzM5Yy00ZTkzLTg0ZTQtNGY2NzczMGU2ZWE3Iiwicm9sZSI6IkFETUlOIiwiaWF0IjoxNzYyNTMyMzEzLCJleHAiOjE3NjI2MTg3MTN9.hz7V7oN_Tm0EYLXrr2wVMCZ0RMDLFy48X2ROUuvWWKk
### Use o mesmo token do admin ou faça login com um organizador
@eventId = 89a91565-38eb-4dea-8166-ac251617fa72
### Evento: "Aniversário da Cris" - ID obtido do sistema
@ticketId = 372d50a9-f308-439a-ab36-c27e824cd3f3
### Para obter: GET /tickets (com token) ou criar um novo ticket
@productId1 = 3e7548a7-e2f1-469d-bba9-2bee8339c5e4
### Para obter: Criar produto via POST /products ou GET /products/event/{{eventId}}
@productId2 = 123d4b0c-780d-4fbb-bda1-4455fbac8e83
### Para obter: Criar produto via POST /products ou GET /products/event/{{eventId}}
@orderId = 5cbeeb17-5502-4372-86ed-8dded33dcef0
### Para obter: Criar pedido via POST /orders ou GET /orders/event/{{eventId}}
@qrCodeData = TICKET_4e2be0eb-9c74-4ac5-8abe-bd146ffeaf10_2026-07-31T05:00:00.000Z_66c76552-c39c-4e93-84e4-4f67730e6ea7
### Para obter: GET /tickets/{id}/qrcode (com token) - campo qrCodeData da resposta
@productQrCode = PRODUCT_b6b5c0c3-4c9e-4a4d-a6fc-f248661b74a7_1762545512391
### Para obter: Criar pedido (POST /orders) - campo qrCodeData dos items retornados
@apiKey = org_89a91565
### API Key gerada automaticamente (primeiros 8 caracteres do eventId)
@scannerId = 1b837e7f-c6d2-40f8-b4f5-a460b51230b2
### Para obter: Criar scanner via POST /scanners (ADMIN) ou GET /scanners (ADMIN)
### Copie o "id" da resposta para usar na validação de produtos
@scannerApiKey = scanner_vd8mf62sefoy2r7dmq6uk
### Para obter: Criar scanner via POST /scanners - campo apiKey da resposta
### (Opcional: usado apenas para autenticação do scanner, não necessário para validação de produtos)

### ============================================
### ETAPA 0: LOGIN (OBTER TOKEN)
### ============================================
### Execute esta requisição primeiro para obter o token JWT
### Copie o "access_token" da resposta para as variáveis @token e @organizerToken acima

### Login como Admin
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "pedro.hp.almeida@gmail.com",
  "password": "PWD@7a7y5f"
}

### Resposta esperada:
### {
###   "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
###   "user": { ... }
### }
### Copie o access_token para @token e @organizerToken acima

### ============================================
### ETAPA 0.5: OBTER MEUS INGRESSOS
### ============================================
### Obter lista de ingressos do usuário logado
### Use o qrCodeData de um ingresso para preencher a variável @qrCodeData
### Use o id do ingresso para preencher a variável @ticketId

GET {{baseUrl}}/tickets/my-tickets
Authorization: Bearer {{token}}

### Resposta esperada:
### {
###   "tickets": [
###     {
###       "id": "uuid-do-ticket",
###       "eventId": "uuid-do-evento",
###       "qrCodeData": "TICKET_abc123...",
###       "qrCode": "data:image/png;base64,...",
###       "qrCodeUrl": "http://localhost:3001/api/tickets/validate?code=TICKET_abc123...&apiKey=org_...",
###       "status": "ACTIVE",
###       ...
###     }
###   ]
### }
### Copie o "id" para @ticketId e "qrCodeData" para @qrCodeData acima

### Obter ingressos do usuário para um evento específico
GET {{baseUrl}}/tickets/my-tickets/{{eventId}}
Authorization: Bearer {{token}}

### ============================================
### ETAPA 1: VALIDAÇÃO DO INGRESSO VIA QR CODE
### ============================================
### Quando o cliente acessa a URL do QR code do ingresso,
### o sistema valida o ingresso e pode retornar dados da comanda

### Validar ingresso e abrir comanda (GET com redirect=comanda)
### URL do QR code do ingresso: {baseUrl}/tickets/validate?code={qrCodeData}&apiKey={apiKey}&redirect=comanda
GET {{baseUrl}}/tickets/validate?code={{qrCodeData}}&apiKey={{apiKey}}&redirect=comanda

### Resposta esperada:
### {
###   "valid": true,
###   "message": "Ingresso válido",
###   "ticket": {
###     "id": "...",
###     "eventId": "...",
###     "userId": "...",
###     "status": "ACTIVE"
###   },
###   "comanda": {
###     "balance": 0.00,
###     "products": [...],
###     "orders": [...]
###   }
### }

### ============================================
### ETAPA 2: CONSULTAR SALDO DE CRÉDITOS
### ============================================
### Cliente verifica seu saldo atual de créditos

GET {{baseUrl}}/credits/balance
Authorization: Bearer {{token}}

### Resposta esperada:
### {
###   "balance": 0.00,
###   "updatedAt": "2024-01-15T10:30:00Z"
### }

### ============================================
### ETAPA 3: ADICIONAR CRÉDITOS
### ============================================
### Cliente adiciona créditos ao seu saldo (simulado, sem gateway)

POST {{baseUrl}}/credits/add
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "amount": 100.00
}

### Resposta esperada:
### {
###   "balance": 100.00,
###   "updatedAt": "2024-01-15T10:30:00Z"
### }

### ============================================
### ETAPA 4: LISTAR PRODUTOS DO EVENTO
### ============================================
### Cliente visualiza produtos disponíveis para compra no evento

### Listar apenas produtos ativos (padrão)
GET {{baseUrl}}/products/event/{{eventId}}?activeOnly=true

### Listar todos os produtos (incluindo inativos)
GET {{baseUrl}}/products/event/{{eventId}}?activeOnly=false

### Resposta esperada:
### [
###   {
###     "id": "...",
###     "eventId": "...",
###     "name": "Cerveja Artesanal",
###     "description": "Cerveja artesanal premium",
###     "price": 15.50,
###     "category": "BEBIDA",
###     "image": "https://example.com/cerveja.jpg",
###     "isActive": true,
###     "createdAt": "2024-01-15T10:30:00Z",
###     "updatedAt": "2024-01-15T10:30:00Z"
###   }
### ]

### ============================================
### ETAPA 5: CADASTRAR PRODUTO (ORGANIZADOR)
### ============================================
### Organizador do evento cadastra produtos que serão vendidos
### NOTA: Apenas organizador do evento pode criar produtos

### Criar produto - Bebida
POST {{baseUrl}}/products
Content-Type: application/json
Authorization: Bearer {{organizerToken}}

{
  "eventId": "{{eventId}}",
  "name": "Cerveja Artesanal",
  "description": "Cerveja artesanal premium",
  "price": 15.50,
  "category": "BEBIDA",
  "image": "https://example.com/cerveja.jpg",
  "isActive": true
}

### Criar produto - Alimento
POST {{baseUrl}}/products
Content-Type: application/json
Authorization: Bearer {{organizerToken}}

{
  "eventId": "{{eventId}}",
  "name": "Hambúrguer Artesanal",
  "description": "Hambúrguer com carne artesanal e queijo",
  "price": 25.00,
  "category": "ALIMENTO",
  "image": "https://example.com/hamburguer.jpg",
  "isActive": true
}

### Resposta esperada:
### {
###   "id": "{{productId1}}",
###   "eventId": "{{eventId}}",
###   "name": "Cerveja Artesanal",
###   "description": "Cerveja artesanal premium",
###   "price": 15.50,
###   "category": "BEBIDA",
###   "image": "https://example.com/cerveja.jpg",
###   "isActive": true,
###   "createdAt": "2024-01-15T10:30:00Z",
###   "updatedAt": "2024-01-15T10:30:00Z"
### }

### ============================================
### ETAPA 6: OBTER DETALHES DE UM PRODUTO
### ============================================
### Cliente ou organizador visualiza detalhes de um produto específico
### NOTA: Execute esta requisição APENAS após criar produtos (ETAPA 5)
### Substitua {{productId1}} pelo ID real do produto criado

### GET {{baseUrl}}/products/{{productId1}}
### Descomente a linha acima e substitua {{productId1}} pelo ID real após criar produtos

### ============================================
### ETAPA 7: CRIAR PEDIDO (COMPRAR PRODUTOS)
### ============================================
### Cliente compra produtos usando seus créditos
### Cada item do pedido gera um QR code único para validação
### NOTA: Substitua {{productId1}} e {{productId2}} pelos IDs reais dos produtos criados na ETAPA 5

POST {{baseUrl}}/orders
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "eventId": "{{eventId}}",
  "ticketId": "{{ticketId}}",
  "items": [
    {
      "productId": "{{productId1}}",
      "quantity": 1
    },
    {
      "productId": "{{productId2}}",
      "quantity": 1
    }
  ]
}

### IMPORTANTE: Antes de executar, substitua {{productId1}} e {{productId2}} pelos IDs reais
### dos produtos criados na ETAPA 5. Caso contrário, você receberá erro 400 (UUID inválido)

### Resposta esperada:
### {
###   "id": "{{orderId}}",
###   "userId": "...",
###   "eventId": "{{eventId}}",
###   "ticketId": "{{ticketId}}",
###   "totalAmount": 56.00,
###   "status": "CONFIRMED",
###   "createdAt": "2024-01-15T10:30:00Z",
###   "updatedAt": "2024-01-15T10:30:00Z",
###   "items": [
###     {
###       "id": "...",
###       "orderId": "{{orderId}}",
###       "productId": "{{productId1}}",
###       "quantity": 2,
###       "unitPrice": 15.50,
###       "totalPrice": 31.00,
###       "qrCodeData": "PRODUCT_abc123...",
###       "qrCodeImage": "data:image/png;base64,...",
###       "status": "PENDING",
###       "validatedAt": null,
###       "validatedBy": null,
###       "createdAt": "2024-01-15T10:30:00Z",
###       "updatedAt": "2024-01-15T10:30:00Z"
###     }
###   ]
### }

### ============================================
### ETAPA 8: CONSULTAR COMANDA DO EVENTO
### ============================================
### Cliente visualiza todos os seus pedidos no evento (comanda)

GET {{baseUrl}}/orders/event/{{eventId}}
Authorization: Bearer {{token}}

### Resposta esperada:
### [
###   {
###     "id": "{{orderId}}",
###     "userId": "...",
###     "eventId": "{{eventId}}",
###     "ticketId": "{{ticketId}}",
###     "totalAmount": 56.00,
###     "status": "CONFIRMED",
###     "createdAt": "2024-01-15T10:30:00Z",
###     "items": [...]
###   }
### ]

### ============================================
### ETAPA 9: OBTER DETALHES DO PEDIDO
### ============================================
### Cliente visualiza detalhes completos de um pedido específico
### NOTA: Execute esta requisição APENAS após criar um pedido (ETAPA 7)
### Substitua {{orderId}} pelo ID real do pedido criado

GET {{baseUrl}}/orders/{{orderId}}
Authorization: Bearer {{token}}

### IMPORTANTE: Antes de executar, substitua {{orderId}} pelo ID real do pedido
### criado na ETAPA 7. Caso contrário, você receberá erro 400 (UUID inválido)

### ============================================
### ETAPA 9.5: CRIAR/OBTER SCANNER (ADMIN)
### ============================================
### Admin cria um scanner para ser usado pelo atendente no bar
### NOTA: Apenas ADMIN pode criar scanners

### Criar scanner para validação de produtos
POST {{baseUrl}}/scanners
Content-Type: application/json
Authorization: Bearer {{token}}

{
  "name": "Scanner Bar - Atendente 1",
  "location": "Bar Principal",
  "role": "VALIDATOR"
}

### Resposta esperada:
### {
###   "id": "uuid-do-scanner",
###   "name": "Scanner Bar - Atendente 1",
###   "apiKey": "scanner_abc123...",
###   "location": "Bar Principal",
###   "role": "VALIDATOR",
###   "status": "ACTIVE",
###   "createdAt": "2024-01-15T10:30:00Z"
### }
### Copie o "id" para @scannerId acima (usado na validação de produtos)
### O "apiKey" pode ser copiado para @scannerApiKey se necessário para autenticação
### NOTA: O secretKey não é retornado por segurança, mas não é necessário para validação de produtos

### Listar todos os scanners (ADMIN)
GET {{baseUrl}}/scanners
Authorization: Bearer {{token}}

### Obter scanner por ID (ADMIN)
GET {{baseUrl}}/scanners/{{scannerId}}
Authorization: Bearer {{token}}

### ============================================
### ETAPA 10: VALIDAÇÃO DO PRODUTO (ATENDENTE)
### ============================================
### Atendente no bar valida o QR code do produto comprado
### O sistema debita o crédito e marca o item como validado
### NOTA: Use o ID do scanner criado na ETAPA 9.5

### Validação via GET (acessando URL do QR code)
GET {{baseUrl}}/products/validate?code={{productQrCode}}&validatedBy={{scannerId}}

### Validação via POST
POST {{baseUrl}}/products/validate
Content-Type: application/json

{
  "code": "{{productQrCode}}",
  "validatedBy": "{{scannerId}}"
}

### Resposta esperada:
### {
###   "valid": true,
###   "message": "Produto validado com sucesso",
###   "orderItem": {
###     "id": "...",
###     "productId": "{{productId1}}",
###     "quantity": 2,
###     "validatedAt": "2024-01-15T10:35:00Z",
###     "validatedBy": "{{scannerId}}"
###   }
### }

### ============================================
### ETAPA 11: VERIFICAR SALDO APÓS COMPRA
### ============================================
### Cliente verifica saldo atualizado após a compra

GET {{baseUrl}}/credits/balance
Authorization: Bearer {{token}}

### Resposta esperada:
### {
###   "balance": 44.00,
###   "updatedAt": "2024-01-15T10:30:00Z"
### }
### (Saldo anterior: 100.00 - Compra: 56.00 = 44.00)

### ============================================
### ETAPAS ADICIONAIS: GERENCIAMENTO DE PRODUTOS (ORGANIZADOR)
### ============================================
### NOTA: Todas as requisições abaixo requerem IDs reais de produtos criados
### Substitua {{productId1}} pelo ID real antes de executar

### Atualizar produto
### PUT {{baseUrl}}/products/{{productId1}}
### Content-Type: application/json
### Authorization: Bearer {{organizerToken}}
### 
### {
###   "name": "Cerveja Artesanal Premium",
###   "price": 18.00,
###   "isActive": true
### }

### Desativar produto
### PUT {{baseUrl}}/products/{{productId1}}
### Content-Type: application/json
### Authorization: Bearer {{organizerToken}}
### 
### {
###   "isActive": false
### }

### Deletar produto
### DELETE {{baseUrl}}/products/{{productId1}}
### Authorization: Bearer {{organizerToken}}

### IMPORTANTE: Descomente e substitua {{productId1}} pelos IDs reais antes de executar

### ============================================
### FLUXO RESUMIDO - ORDEM DE EXECUÇÃO
### ============================================
### 1. Cliente acessa QR code do ingresso → Validação + Abertura de comanda
### 2. Cliente consulta saldo de créditos
### 3. Cliente adiciona créditos (se necessário)
### 4. Cliente lista produtos disponíveis do evento
### 5. [ORGANIZADOR] Cadastra produtos no evento
### 6. Cliente cria pedido (compra produtos) → Gera QR codes para cada item
### 7. Cliente consulta comanda do evento
### 8. Cliente visualiza QR codes dos produtos comprados
### 9. [ADMIN] Cria scanner para atendente (se ainda não existir)
### 10. [ATENDENTE] Valida QR code do produto → Debita crédito e marca como validado
### 11. Cliente verifica saldo atualizado

### ============================================
### NOTAS IMPORTANTES
### ============================================
### - Créditos são GLOBAIS para o usuário (servem para múltiplos eventos)
### - Produtos são ESPECÍFICOS por evento
### - Cada produto comprado gera um QR code único
### - QR code do produto só pode ser validado UMA vez
### - Apenas organizador do evento pode criar/editar/deletar produtos
### - Cliente precisa ter saldo suficiente para comprar produtos
### - Validação do produto debita créditos automaticamente

